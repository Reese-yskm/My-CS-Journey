# 变量的作用域与生存期 (Scope and Storage Duration)

## 1. 全局变量 (Global Variables)
### 1.1 定义与可见性
*   **定义**：在所有函数体外部定义的变量。
*   **作用域（Scope）**：从定义点开始，到程序文件结束。默认具有外部链接属性，可被同一工程内的其他文件访问（需配合 `extern`）。
*   **生存期（Lifetime）**：与程序的运行期一致。程序启动时分配空间，程序退出时释放。

### 1.2 存储与初始化
*   **自动初始化**：若未显式初始化，全局变量会自动初始化为 `0`。
*   **物理存储**：存储在**数据段（Data Segment）**。其中，初始化的全局变量存放在 `.data` 段，未初始化的存放在 `.bss` 段。
*   **工程建议**：尽量减少全局变量的使用，以降低函数间的耦合度，防止副作用难以追踪。

## 2. 静态本地变量 (Static Local Variables)
### 2.1 定义与核心特性
*   **语法**：在本地变量前加 `static` 关键字。
*   **本质**：静态本地变量是**具有本地作用域的全局变量**。
*   **特性**：
    1.  **持久化**：函数返回后，变量的值保持不变，下次进入函数时沿用旧值。
    2.  **唯一初始化**：初始化仅在程序首次执行该定义语句时发生一次。

### 2.2 存储机制
*   **存储位置**：尽管定义在函数内部，但它**不存储在栈（Stack）上**，而是存储在**全局数据段**。
*   **可见性约束**：由编译器限制，仅在该函数内部可见。

## 3. 返回指针的函数及其陷阱
### 3.1 栈空间失效陷阱 (The Stack Return Trap)
*   **核心禁令**：**绝不能返回指向本地变量（自动变量）的指针。**
*   **失效机理**：本地变量存储在栈帧（Stack Frame）中。当函数返回时，其栈帧被撤销，该内存区域变为“过期”状态，可能随时被后续函数调用覆盖。返回该地址会导致**悬空指针（Dangling Pointer）**。

### 3.2 合法的返回策略
若需从函数返回一个有效的指针，目标内存必须处于以下三个区域之一：
1.  **全局变量区**：返回指向全局变量的地址。
2.  **静态存储区**：返回指向函数内 `static` 变量的地址（注意：这会使函数变得不可重入，即不适用于多线程环境）。
3.  **堆（Heap）空间**：返回由 `malloc` 动态分配的地址。调用者需负责后续的 `free` 操作（即内存所有权的转移）。

---

### 💡 [NJU ICS 视角] 深度补丁

1.  **符号表与重定位**：在下学期学链接（Linking）时，你会明白全局变量会进入**符号表（Symbol Table）**，而本地变量只是栈指针（ESP/RSP）的偏移量。
2.  **隐藏状态**：`static` 变量在 C 语言中常用于模拟“私有成员”，它是模块化编程中封装状态的核心手段。
3.  **段错误预防**：理解变量存在于哪个 Segment（.text / .data / .stack / .heap）是排查 `Segmentation Fault` 的理论基石。
